---
phase: 03-data-access-deployment
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - deploy.sh
autonomous: false

must_haves:
  truths:
    - "deploy.sh builds TypeScript, installs production-only dependencies, and copies build + node_modules + package.json to ~/lightdash-mcp/"
    - "The deployed server at ~/lightdash-mcp/build/index.js starts successfully with LIGHTDASH_API_KEY and LIGHTDASH_API_URL env vars"
    - "Claude Desktop config JSON with mcpServers.lightdash entry is printed to stdout by deploy script"
  artifacts:
    - path: "deploy.sh"
      provides: "Shell script that builds and deploys the MCP server to ~/lightdash-mcp/"
      contains: "npm run build"
    - path: "$HOME/lightdash-mcp/build/index.js"
      provides: "Compiled MCP server entry point at deploy location"
  key_links:
    - from: "deploy.sh"
      to: "package.json"
      via: "npm run build and npm ci --omit=dev"
      pattern: "npm run build"
    - from: "deploy.sh"
      to: "$HOME/lightdash-mcp/"
      via: "cp -r build node_modules package.json"
      pattern: "cp.*DEPLOY_DIR"
---

<objective>
Create the deploy script (BLDP-02) that builds the TypeScript server and copies it to ~/lightdash-mcp/ for Claude Desktop use, then verify the full end-to-end deployment (BLDP-03).

Purpose: Completes the build-deploy pipeline so the MCP server can be used from Claude Desktop with a simple config entry.
Output: deploy.sh script, deployed server at ~/lightdash-mcp/, Claude Desktop config instructions.
</objective>

<execution_context>
@/Users/mikhailgasanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mikhailgasanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-data-access-deployment/03-RESEARCH.md

@package.json
@src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create deploy.sh build and deployment script</name>
  <files>deploy.sh</files>
  <action>
Create `deploy.sh` in the project root. The script must:

1. Start with `#!/usr/bin/env bash` and `set -euo pipefail`
2. Set `DEPLOY_DIR="$HOME/lightdash-mcp"` -- use $HOME not ~ (tilde expansion is unreliable in non-interactive contexts)
3. Echo "Building TypeScript..." and run `npm run build`
4. Echo "Installing production dependencies..." and run `npm ci --omit=dev` (this removes devDependencies from node_modules so only production deps remain for copying)
5. Echo "Deploying to $DEPLOY_DIR..." and:
   - `rm -rf "$DEPLOY_DIR"` (clean previous deploy)
   - `mkdir -p "$DEPLOY_DIR"`
   - `cp -r build "$DEPLOY_DIR/"`
   - `cp -r node_modules "$DEPLOY_DIR/"`
   - `cp package.json "$DEPLOY_DIR/"`
6. After copying, restore full dev dependencies for the source project: `npm ci` (re-installs all deps including devDependencies so the developer can keep working)
7. Echo success message and print the Claude Desktop configuration JSON:
   ```
   echo ""
   echo "Deployed successfully to $DEPLOY_DIR"
   echo ""
   echo "Add this to your Claude Desktop config"
   echo "(~/Library/Application Support/Claude/claude_desktop_config.json on macOS):"
   echo ""
   cat << CONFIG
   {
     "mcpServers": {
       "lightdash": {
         "command": "node",
         "args": ["$DEPLOY_DIR/build/index.js"],
         "env": {
           "LIGHTDASH_API_KEY": "your-lightdash-personal-access-token",
           "LIGHTDASH_API_URL": "https://your-lightdash-instance.com"
         }
       }
     }
   }
   CONFIG
   ```
   NOTE: The CONFIG heredoc must NOT use quotes around CONFIG so that $DEPLOY_DIR gets expanded to the actual path in the output. This way the user sees the real path, not a variable reference.

8. Make the script executable: after writing, run `chmod +x deploy.sh`.

IMPORTANT: The script runs in the project root directory. All npm commands use the project's package.json.
  </action>
  <verify>Run `bash deploy.sh` from the project root. Verify: (1) build/ directory exists, (2) ~/lightdash-mcp/ directory exists with build/, node_modules/, and package.json, (3) `node ~/lightdash-mcp/build/index.js` exits with the expected "LIGHTDASH_API_KEY is not set" error (proving it starts and validates env vars).</verify>
  <done>deploy.sh exists, is executable, builds TypeScript, deploys to ~/lightdash-mcp/, and prints Claude Desktop config with real path. Deployed server validates env vars on startup.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify end-to-end deployment and Claude Desktop readiness</name>
  <files>deploy.sh</files>
  <action>
Human verification checkpoint. Present the user with the deployment results and Claude Desktop configuration instructions for manual verification.
  </action>
  <verify>User confirms deployment works by running the deployed server and optionally testing in Claude Desktop.</verify>
  <done>User has approved the deployment. Phase 3 is complete.</done>
  <what-built>
Complete MCP server with 10 tools (6 discovery + 4 data access), built and deployed to ~/lightdash-mcp/. Deploy script ran successfully and printed Claude Desktop configuration.
  </what-built>
  <how-to-verify>
1. Check the deployed server starts and validates env vars:
   ```
   node ~/lightdash-mcp/build/index.js
   ```
   Expected: stderr message "FATAL: LIGHTDASH_API_KEY is not set" and exit code 1.

2. Check the deployed server starts with valid env vars (if you have them):
   ```
   LIGHTDASH_API_KEY=your-key LIGHTDASH_API_URL=https://your-instance.com node ~/lightdash-mcp/build/index.js
   ```
   Expected: stderr message "Lightdash MCP server started on stdio transport" (then hangs waiting for stdin -- Ctrl+C to exit).

3. (Optional) Add the config to Claude Desktop and test a full workflow:
   - Open ~/Library/Application Support/Claude/claude_desktop_config.json
   - Add the mcpServers.lightdash entry with your real API key and URL
   - Restart Claude Desktop
   - Ask Claude to "list my Lightdash projects" -- should call lightdash_list_projects
   - Ask Claude to "search for charts about revenue" -- should call lightdash_search_charts
   - Ask Claude to "get the explore schema for orders" -- should call lightdash_get_explore
  </how-to-verify>
  <resume-signal>Type "approved" to complete Phase 3, or describe any issues.</resume-signal>
</task>

</tasks>

<verification>
1. deploy.sh exists and is executable (chmod +x)
2. deploy.sh uses $HOME not ~ for path safety
3. Running deploy.sh creates ~/lightdash-mcp/ with build/, node_modules/, package.json
4. `node ~/lightdash-mcp/build/index.js` starts and validates env vars
5. Claude Desktop config JSON printed with correct path to deployed index.js
6. Source project still has devDependencies after deploy (npm ci restores them)
</verification>

<success_criteria>
- deploy.sh builds TypeScript, copies production artifacts to ~/lightdash-mcp/
- Deployed server starts via `node ~/lightdash-mcp/build/index.js` and validates env vars
- Claude Desktop config JSON is correct and uses literal values (no shell variable references for the user)
- Full project is deployable and ready for Claude Desktop integration
</success_criteria>

<output>
After completion, create `.planning/phases/03-data-access-deployment/03-03-SUMMARY.md`
</output>
